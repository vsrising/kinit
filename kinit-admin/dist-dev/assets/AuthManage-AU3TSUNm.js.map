{"version":3,"file":"AuthManage-AU3TSUNm.js","sources":["../../src/views/Vadmin/Auth/Role/components/AuthManage.vue"],"sourcesContent":["<script setup lang=\"ts\">\nimport {\n  ElDrawer,\n  ElDivider,\n  ElSelect,\n  ElOption,\n  ElTree,\n  ElContainer,\n  ElHeader,\n  ElAside,\n  ElMain,\n  ElMessage\n} from 'element-plus'\nimport { ref, nextTick, unref, PropType, watch } from 'vue'\nimport { Icon } from '@/components/Icon'\nimport { useDictStore } from '@/store/modules/dict'\nimport { getMenuRoleTreeOptionsApi } from '@/api/vadmin/auth/menu'\nimport { getDeptUserTreeOptionsApi } from '@/api/vadmin/auth/dept'\nimport { eachTree } from '@/utils/tree'\nimport { isEmptyVal } from '@/utils/is'\nimport { putRoleListApi } from '@/api/vadmin/auth/role'\n\nconst props = defineProps({\n  currentRow: {\n    type: Object as PropType<any>,\n    default: () => null\n  }\n})\n\nconst emit = defineEmits(['getList'])\n\nconst data = ref({} as Recordable)\n\nwatch(\n  () => props.currentRow,\n  (currentRow) => {\n    if (!currentRow) return\n    data.value = JSON.parse(JSON.stringify(currentRow))\n  },\n  {\n    deep: true,\n    immediate: true\n  }\n)\n\nconst drawerVisible = ref(false)\n\nconst dataRangeOptions = ref()\nconst getOptions = async () => {\n  const dictStore = useDictStore()\n  const dictOptions = await dictStore.getDictObj(['sys_vadmin_data_range'])\n  dataRangeOptions.value = dictOptions.sys_vadmin_data_range\n}\n\nconst defaultProps = {\n  children: 'children',\n  label: 'label'\n}\n\n// 获取部门树\nlet deptTreeData = ref([] as any[])\nconst deptTreeRef = ref<InstanceType<typeof ElTree>>()\nconst getDeptTreeOptions = async () => {\n  const res = await getDeptUserTreeOptionsApi()\n  if (res) {\n    deptTreeData.value = res.data\n    await nextTick()\n    if (props.currentRow) {\n      const dept_ids: number[] = props.currentRow.depts.map((item) => item.id)\n      const checked: number[] = []\n      // 递归按顺序添加选中的菜单项，用于处理半选状态的菜单项\n      eachTree(res.data, (v) => {\n        if (dept_ids.includes(v.value)) {\n          checked.push(v.value)\n        }\n      })\n      for (const item of checked) {\n        unref(deptTreeRef)?.setChecked(item, true, false)\n      }\n    }\n  }\n}\n\n// 获取菜单树\nlet menuTreeData = ref([] as any[])\nconst menuTreeRef = ref<InstanceType<typeof ElTree>>()\nconst getMenuRoleTreeOptions = async () => {\n  const res = await getMenuRoleTreeOptionsApi()\n  if (res) {\n    menuTreeData.value = res.data\n    await nextTick()\n    if (props.currentRow) {\n      const menu_ids: number[] = props.currentRow.menus.map((item) => item.id)\n      const checked: number[] = []\n      // 递归按顺序添加选中的菜单项，用于处理半选状态的菜单项\n      eachTree(res.data, (v) => {\n        if (menu_ids.includes(v.value)) {\n          checked.push(v.value)\n        }\n      })\n      for (const item of checked) {\n        unref(menuTreeRef)?.setChecked(item, true, false)\n      }\n    }\n  }\n}\n\nconst loading = ref(false)\n\nconst submit = async () => {\n  if (loading.value) return\n  if (isEmptyVal(data.value.data_range)) {\n    ElMessage.error('数据范围选择项不能为空！')\n    return\n  }\n  loading.value = true\n  const menu_ids = [\n    ...(unref(menuTreeRef)?.getCheckedKeys() || []),\n    ...(unref(menuTreeRef)?.getHalfCheckedKeys() || [])\n  ]\n  data.value.menu_ids = menu_ids\n  data.value.dept_ids = unref(deptTreeRef)?.getCheckedKeys()\n  try {\n    const res = await putRoleListApi(data.value)\n    if (res) {\n      loading.value = false\n      ElMessage.success('保存成功')\n      closeDrawer()\n      emit('getList')\n    }\n  } finally {\n    loading.value = false\n  }\n}\n\nconst openDrawer = () => {\n  drawerVisible.value = true\n  getMenuRoleTreeOptions()\n  getDeptTreeOptions()\n}\n\nconst closeDrawer = () => {\n  drawerVisible.value = false\n  data.value = {}\n  unref(menuTreeRef)?.setCheckedKeys([])\n  unref(deptTreeRef)?.setCheckedKeys([])\n}\n\ngetOptions()\n\ndefineExpose({\n  openDrawer\n})\n</script>\n\n<template>\n  <div class=\"auth-manage-main-view\">\n    <ElDrawer v-model=\"drawerVisible\" :with-header=\"false\" :size=\"1000\" :before-close=\"closeDrawer\">\n      <ElContainer>\n        <ElHeader>\n          <div class=\"flex justify-between pt-[20px] pb-[20px]\">\n            <span>权限管理</span>\n            <span @click=\"closeDrawer\" class=\"flex cursor-pointer\">\n              <Icon icon=\"iconamoon:close-thin\" :size=\"23\" />\n            </span>\n          </div>\n        </ElHeader>\n        <ElDivider />\n        <div class=\"h-12 flex justify-between mt-3 mr-3 ml-5\">\n          <div class=\"mt-1 text-[#909399]\">\n            <span>角色名称：{{ data.name }}</span>\n          </div>\n          <BaseButton type=\"primary\" :loading=\"loading\" @click=\"submit\">保存</BaseButton>\n        </div>\n        <ElDivider />\n        <ElContainer>\n          <ElAside width=\"450px\">\n            <div class=\"border-r-1 border-r-[#f0f0f0] b-r-solid h-[100%] p-[20px] box-border\">\n              <div>\n                <div class=\"flex items-center\">\n                  <div class=\"yxt-divider\"></div>\n                  <span>数据权限</span>\n                </div>\n                <div class=\"ml-4 mt-3\">\n                  <ElSelect v-model=\"data.data_range\" placeholder=\"请选择数据范围\">\n                    <ElOption\n                      v-for=\"item in dataRangeOptions\"\n                      :key=\"item.value\"\n                      :label=\"item.label\"\n                      :value=\"item.value\"\n                    />\n                  </ElSelect>\n                  <div\n                    v-if=\"data.data_range === '3'\"\n                    class=\"mt-3 max-h-[65vh] b-1 b-solid b-[#e5e7eb] p-10px overflow-auto\"\n                  >\n                    <ElTree\n                      ref=\"deptTreeRef\"\n                      :data=\"deptTreeData\"\n                      show-checkbox\n                      node-key=\"value\"\n                      :props=\"defaultProps\"\n                      :default-expand-all=\"true\"\n                      :check-strictly=\"true\"\n                    />\n                  </div>\n                </div>\n              </div>\n            </div>\n          </ElAside>\n          <ElMain>\n            <div class=\"flex items-center\">\n              <div class=\"yxt-divider\"></div>\n              <span>菜单权限</span>\n            </div>\n            <div class=\"mt-5 max-h-[70vh] b-1 b-solid b-[#e5e7eb] p-10px overflow-auto box-border\">\n              <ElTree\n                ref=\"menuTreeRef\"\n                :data=\"menuTreeData\"\n                show-checkbox\n                node-key=\"value\"\n                :props=\"defaultProps\"\n                :default-expand-all=\"true\"\n                :check-strictly=\"false\"\n              />\n            </div>\n          </ElMain>\n        </ElContainer>\n      </ElContainer>\n      <ElDivider />\n\n      <!-- <ElDivider /> -->\n    </ElDrawer>\n  </div>\n</template>\n\n<style lang=\"less\">\n.auth-manage-main-view .el-drawer .el-drawer__body {\n  padding: 0;\n}\n.auth-manage-main-view .el-divider.el-divider--horizontal {\n  margin: 0;\n}\n</style>\n\n<style scoped lang=\"less\">\n.yxt-divider {\n  background: #409eff;\n  width: 8px;\n  height: 20px;\n  display: inline-block;\n  margin-right: 10px;\n}\n</style>\n"],"names":["props","__props","emit","__emit","data","ref","watch","currentRow","drawerVisible","dataRangeOptions","getOptions","__async","dictOptions","useDictStore","defaultProps","deptTreeData","deptTreeRef","getDeptTreeOptions","res","getDeptUserTreeOptionsApi","nextTick","dept_ids","item","checked","eachTree","v","_a","unref","menuTreeData","menuTreeRef","getMenuRoleTreeOptions","getMenuRoleTreeOptionsApi","menu_ids","loading","submit","isEmptyVal","ElMessage","_b","_c","putRoleListApi","closeDrawer","openDrawer","__expose"],"mappings":"wmDAsBA,MAAMA,EAAQC,EAORC,EAAOC,EAEPC,EAAOC,EAAI,CAAA,CAAgB,EAEjCC,GACE,IAAMN,EAAM,WACXO,GAAe,CACTA,IACLH,EAAK,MAAQ,KAAK,MAAM,KAAK,UAAUG,CAAU,CAAC,EACpD,EACA,CACE,KAAM,GACN,UAAW,EACb,CAAA,EAGI,MAAAC,EAAgBH,EAAI,EAAK,EAEzBI,EAAmBJ,IACnBK,EAAa,IAAYC,EAAA,sBAE7B,MAAMC,EAAc,MADFC,IACkB,WAAW,CAAC,uBAAuB,CAAC,EACxEJ,EAAiB,MAAQG,EAAY,qBAAA,GAGjCE,EAAe,CACnB,SAAU,WACV,MAAO,OAAA,EAIL,IAAAC,EAAeV,EAAI,CAAA,CAAW,EAClC,MAAMW,EAAcX,IACdY,EAAqB,IAAYN,EAAA,4BAC/B,MAAAO,EAAM,MAAMC,IAClB,GAAID,IACFH,EAAa,MAAQG,EAAI,KACzB,MAAME,EAAS,EACXpB,EAAM,YAAY,CACd,MAAAqB,EAAqBrB,EAAM,WAAW,MAAM,IAAKsB,GAASA,EAAK,EAAE,EACjEC,EAAoB,CAAA,EAEjBC,EAAAN,EAAI,KAAOO,GAAM,CACpBJ,EAAS,SAASI,EAAE,KAAK,GACnBF,EAAA,KAAKE,EAAE,KAAK,CACtB,CACD,EACD,UAAWH,KAAQC,GACjBG,EAAAC,EAAMX,CAAW,IAAjB,MAAAU,EAAoB,WAAWJ,EAAM,GAAM,GAE/C,CACF,GAIE,IAAAM,EAAevB,EAAI,CAAA,CAAW,EAClC,MAAMwB,EAAcxB,IACdyB,EAAyB,IAAYnB,EAAA,4BACnC,MAAAO,EAAM,MAAMa,IAClB,GAAIb,IACFU,EAAa,MAAQV,EAAI,KACzB,MAAME,EAAS,EACXpB,EAAM,YAAY,CACd,MAAAgC,EAAqBhC,EAAM,WAAW,MAAM,IAAKsB,GAASA,EAAK,EAAE,EACjEC,EAAoB,CAAA,EAEjBC,EAAAN,EAAI,KAAOO,GAAM,CACpBO,EAAS,SAASP,EAAE,KAAK,GACnBF,EAAA,KAAKE,EAAE,KAAK,CACtB,CACD,EACD,UAAWH,KAAQC,GACjBG,EAAAC,EAAME,CAAW,IAAjB,MAAAH,EAAoB,WAAWJ,EAAM,GAAM,GAE/C,CACF,GAGIW,EAAU5B,EAAI,EAAK,EAEnB6B,EAAS,IAAYvB,EAAA,gCACzB,GAAIsB,EAAQ,MAAO,OACnB,GAAIE,EAAW/B,EAAK,MAAM,UAAU,EAAG,CACrCgC,EAAU,MAAM,cAAc,EAC9B,MACF,CACAH,EAAQ,MAAQ,GAChB,MAAMD,EAAW,CACf,KAAIN,EAAAC,EAAME,CAAW,IAAjB,YAAAH,EAAoB,mBAAoB,CAAC,EAC7C,KAAIW,EAAAV,EAAME,CAAW,IAAjB,YAAAQ,EAAoB,uBAAwB,CAAC,CAAA,EAEnDjC,EAAK,MAAM,SAAW4B,EACtB5B,EAAK,MAAM,UAAWkC,EAAAX,EAAMX,CAAW,IAAjB,YAAAsB,EAAoB,iBACtC,GAAA,EACU,MAAMC,EAAenC,EAAK,KAAK,KAEzC6B,EAAQ,MAAQ,GAChBG,EAAU,QAAQ,MAAM,EACZI,IACZtC,EAAK,SAAS,EAChB,QACA,CACA+B,EAAQ,MAAQ,EAClB,CAAA,GAGIQ,EAAa,IAAM,CACvBjC,EAAc,MAAQ,GACCsB,IACJb,GAAA,EAGfuB,EAAc,IAAM,SACxBhC,EAAc,MAAQ,GACtBJ,EAAK,MAAQ,IACbsB,EAAAC,EAAME,CAAW,IAAjB,MAAAH,EAAoB,eAAe,CAAE,IACrCW,EAAAV,EAAMX,CAAW,IAAjB,MAAAqB,EAAoB,eAAe,CAAE,EAAA,EAG5B,OAAA3B,IAEEgC,EAAA,CACX,WAAAD,CAAA,CACD"}