var Z=Object.defineProperty;var B=Object.getOwnPropertySymbols;var ee=Object.prototype.hasOwnProperty,ae=Object.prototype.propertyIsEnumerable;var D=(r,o,l)=>o in r?Z(r,o,{enumerable:!0,configurable:!0,writable:!0,value:l}):r[o]=l,F=(r,o)=>{for(var l in o||(o={}))ee.call(o,l)&&D(r,l,o[l]);if(B)for(var l of B(o))ae.call(o,l)&&D(r,l,o[l]);return r};var _=(r,o,l)=>new Promise((x,g)=>{var C=u=>{try{w(l.next(u))}catch(v){g(v)}},T=u=>{try{w(l.throw(u))}catch(v){g(v)}},w=u=>u.done?x(u.value):Promise.resolve(u.value).then(C,T);w((l=l.apply(r,o)).next())});import{a as te,r as le,b as se,d as oe,c as ne,p as ie}from"./task-P-hTJlj1.js";import{u as re,_ as ue}from"./Table.vue_vue_type_script_lang-mknq5iMW.js";import{d as de,q as d}from"./index-E_cr-WWq.js";import{_ as pe}from"./Search.vue_vue_type_script_setup_true_lang-FyVOhxsu.js";import{_ as ce}from"./ContentWrap.vue_vue_type_script_setup_true_lang-M_zuHec9.js";import{_ as me}from"./Write.vue_vue_type_script_setup_true_lang-4Eg9JnHS.js";import{_ as fe}from"./Dialog.vue_vue_type_style_index_0_lang-ZHiEjFP2.js";import{l as _e,aC as ve,J as O,O as s,P as A,V as p,a as c,m as P,p as ge,R as i,u as a,B as U,U as I,W as M,X as N}from"./vue-chunks-NBL-ZipP.js";import{_ as we}from"./CronExpression.vue_vue_type_style_index_0_lang-Z6TSUVzF.js";import{z as ye,aa as ke,b as j,m as be,g as S}from"./element-plus-LfFKO5To.js";import"./useForm-agan0gLz.js";import"./style.css_vue_type_style_index_0_src_true_lang-vVOIijJh.js";import"./wang-editor-izIlk5n1.js";import"./_Uint8Array-x8CL7VG0.js";import"./useIcon-gh8Uv9vA.js";import"./useValidator-b4d-vg8t.js";import"./dict-5fAUqSge.js";import"./dict-vhQapUcV.js";import"./RunDatetimeList-DIhRBlso.js";import"./CronExample-NAedFfqG.js";const je=_e({name:"SystemTask",__name:"Task",setup(r){const{push:o}=ve(),{t:l}=de(),{tableRegister:x,tableState:g,tableMethods:C}=re({fetchDataApi:()=>_(this,null,function*(){const{pageSize:t,currentPage:e}=g,n=yield se(F({page:a(e),limit:a(t)},a(z)));return{list:n.data||[],total:n.count||0}}),fetchDelApi:t=>_(this,null,function*(){return(yield oe(t)).code===200})}),{dataList:T,loading:w,total:u,pageSize:v,currentPage:y}=g,{getList:k,delList:q}=C,J=O([{field:"_id",label:"任务编号",show:!0,disabled:!0,width:"230px",span:24},{field:"name",label:"任务名称",show:!0,disabled:!0,span:24},{field:"group",label:"任务分组",show:!0,span:24},{field:"job_class",label:"调用目标",show:!0,span:24},{field:"exec_strategy",label:"执行策略",show:!0,colProps:{span:24},componentProps:{style:{width:"100%"}}},{field:"expression",label:"表达式",show:!0,span:24},{field:"is_active",label:"任务状态",show:!0,width:"100px",slots:{default:t=>{const e=t.row;return s(A,null,[s(ye,{modelValue:e.is_active,disabled:!0},null)])}}},{field:"last_run_datetime",label:"最近一次执行时间",show:!0,width:"180px",span:24},{field:"remark",label:"任务备注",show:!0,span:24},{field:"create_datetime",label:"创建时间",show:!0,width:"180px",span:24},{field:"action",label:"操作",show:!0,disabled:!1,width:"240px",slots:{default:t=>{const e=t.row;return s(A,null,[s(d,{type:"primary",link:!0,size:"small",onClick:()=>G(e)},{default:()=>[p("编辑")]}),s(d,{type:"primary",link:!0,size:"small",onClick:()=>V(e)},{default:()=>[p("调度日志")]}),s(d,{type:"primary",link:!0,size:"small",onClick:()=>Y(e)},{default:()=>[p("执行一次")]}),s(d,{type:"danger",link:!0,size:"small",onClick:()=>X(e)},{default:()=>[p("删除")]})])}}}]),W=O([{field:"name",label:"任务名称",component:"Input",componentProps:{clearable:!0,style:{width:"214px"}}},{field:"_id",label:"任务编号",component:"Input",componentProps:{clearable:!0,style:{width:"214px"}}},{field:"group",label:"任务分组",component:"Select",componentProps:{style:{width:"214px"},options:[]}}]),z=c({}),E=t=>{y.value=1,z.value=t,k()},$=c(!1),X=t=>_(this,null,function*(){$.value=!0,yield q(!0,[t._id]).finally(()=>{$.value=!1})}),m=c(!1),b=c(""),h=c(),f=c(""),L=c(),R=c(!1),G=t=>_(this,null,function*(){const e=yield te(t._id);e&&(b.value="编辑定时任务",f.value="edit",h.value=e.data,m.value=!0)}),H=()=>{b.value="新增定时任务",f.value="add",h.value=void 0,m.value=!0},K=()=>_(this,null,function*(){const t=a(L),e=yield t==null?void 0:t.submit();if(e){R.value=!0;try{const n=c({});f.value==="add"?(n.value=yield ne(e),n.value&&(m.value=!1,k())):f.value==="edit"&&(n.value=yield ie(e._id,e),n.value&&(m.value=!1,k()))}finally{R.value=!1}}}),Q=()=>{b.value="Cron 表达式",f.value="expression",h.value=void 0,m.value=!0},V=t=>{o(t?`/record/task?job_id=${t._id}`:"/record/task")},Y=t=>_(this,null,function*(){ke.confirm("是否确认立即执行一次任务","提示",{confirmButtonText:l("common.delOk"),cancelButtonText:l("common.delCancel"),type:"warning"}).then(()=>_(this,null,function*(){const e=yield le(t._id);e&&(e.data>0?j.success("任务成功被消费者接收！"):j.error("执行失败，未有消费者接收任务，请检查定时任务程序状态！"))}))});return(t,e)=>(P(),ge(A,null,[s(a(ce),null,{default:i(()=>[s(a(pe),{schema:W,onReset:E,onSearch:E},null,8,["schema"]),s(a(ue),{"current-page":a(y),"onUpdate:currentPage":e[1]||(e[1]=n=>U(y)?y.value=n:null),"page-size":a(v),"onUpdate:pageSize":e[2]||(e[2]=n=>U(v)?v.value=n:null),showAction:"",columns:J,"default-expand-all":"","node-key":"id",data:a(T),loading:a(w),pagination:{total:a(u)},onRegister:a(x),onRefresh:a(k)},{toolbar:i(()=>[s(a(be),{gutter:10},{default:i(()=>[s(a(S),{span:1.5},{default:i(()=>[s(a(d),{type:"primary",onClick:H},{default:i(()=>[p("新增定时任务")]),_:1})]),_:1}),s(a(S),{span:1.5},{default:i(()=>[s(a(d),{type:"primary",onClick:e[0]||(e[0]=n=>V(null))},{default:i(()=>[p("调度日志")]),_:1})]),_:1}),s(a(S),{span:1.5},{default:i(()=>[s(a(d),{type:"primary",onClick:Q},{default:i(()=>[p("快速生成 Cron 表达式")]),_:1})]),_:1})]),_:1})]),_:1},8,["current-page","page-size","columns","data","loading","pagination","onRegister","onRefresh"])]),_:1}),s(a(fe),{modelValue:m.value,"onUpdate:modelValue":e[4]||(e[4]=n=>m.value=n),title:b.value,height:680,width:850},{footer:i(()=>[s(a(d),{type:"primary",loading:R.value,onClick:K},{default:i(()=>[p(I(a(l)("exampleDemo.save")),1)]),_:1},8,["loading"]),s(a(d),{onClick:e[3]||(e[3]=n=>m.value=!1)},{default:i(()=>[p(I(a(l)("dialogDemo.close")),1)]),_:1})]),default:i(()=>[f.value==="add"||f.value==="edit"?(P(),M(me,{key:0,ref_key:"writeRef",ref:L,"current-row":h.value},null,8,["current-row"])):N("",!0),f.value==="expression"?(P(),M(we,{key:1})):N("",!0)]),_:1},8,["modelValue","title"])],64))}});export{je as default};
//# sourceMappingURL=Task-dEcROHri.js.map
